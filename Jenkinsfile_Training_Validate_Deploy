pipeline {
  agent any

  triggers {
    cron('0 0 * * 0')  // minuit chaque dimanche (dÃ©but de semaine)
  }

  environment {
    WORKSPACE_DIR = '/var/jenkins_home/workspace'
    VENV_DIR      = '.venv'
    VENV_PATH     = "${WORKSPACE_DIR}/${VENV_DIR}"
    PYTHONPATH    = "${WORKSPACE_DIR}"
    ENV_FILE      = "${WORKSPACE_DIR}/.env"
    FASTAPI_URL = 'http://fastapi:8000'
  }

  stages {
    stage('Setup Python venv') {
      steps {
        echo 'ðŸ”§ CrÃ©ation du venv + install deps'
        sh '''set -e
python3 -m venv "${VENV_PATH}"
. "${VENV_PATH}/bin/activate"
python -V
python -m pip install --upgrade pip
python -m pip install -r "${WORKSPACE_DIR}/requirements_test.txt"
'''
      }
    }

    stage('Check Installed Packages') {
      steps {
        echo "ðŸ“¦ VÃ©rification des libs"
        sh '''set -e
. "${VENV_PATH}/bin/activate"
python -m pip show numpy || echo "âŒ numpy non trouvÃ©"
python -m pip list | grep numpy || true
'''
      }
    }

    stage('Train_AQI') {
      steps {
        echo 'ðŸš€ ExÃ©cution de train_aqi_fine_tuning.py'
        sh '''set -e
. "${VENV_PATH}/bin/activate"
export PYTHONPATH="${PYTHONPATH}"
export ENV_FILE="${ENV_FILE}"
cd ${WORKSPACE_DIR}
python scripts/model/train_aqi_fine_tuning.py
'''
      }
      post {
        success { echo "âœ… OK: Training Avec Success" }
        failure { echo "âŒ KO: Training Avec Echec" }
      }
    }


    stage('Evaluate_Validate') {
      steps {
        echo 'ðŸš€ ExÃ©cution de validate_and_promote_aqi.py'
        sh '''set -e
. "${VENV_PATH}/bin/activate"
export PYTHONPATH="${PYTHONPATH}"
export ENV_FILE="${ENV_FILE}"
cd ${WORKSPACE_DIR}
python scripts/model/validate_and_promote_aqi.py
'''
      }
      post {
        success { echo "âœ… OK: Promotion Avec Success" }
        failure { echo "âŒ KO: Promotion Avec Echec" }
      }
    }

  

stage('Deploy') {
  steps {
    sh '''
      set -e
      for i in $(seq 1 30); do
        if curl -sSf --max-time 3 http://fastapi:8000/health >/dev/null; then break; fi
        echo "â³ FastAPI pas encore prÃªt (${i}/30)â€¦"; sleep 2
      done
      curl -sSf --max-time 10 http://fastapi:8000/reload >/dev/null
      sleep 2
      curl -sSf --max-time 10 http://fastapi:8000/health >/dev/null
      echo "âœ… Reload OK"
    '''
  }
}







  }
  post {
    success { echo 'âœ… Pipeline OK' }
    failure { echo 'â›” Pipeline KO' }
  }
}
